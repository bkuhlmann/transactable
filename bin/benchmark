#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "benchmark-ips"
  gem "dry-transaction"
  gem "kwork", github: "nebulab/kwork"
  gem "transactable", path: ".."
end

require "benchmark"
require "json"

Profiler = lambda do |callback, _name, _positionals, _keywords, _block|
  result = nil
  Benchmark.measure { result = callback.call }
  result
end

# For monad comparison.
Monader = Class.new do
  include Dry::Monads[:result]

  def call body
    Success(body).fmap { |content| JSON content, symbolize_names: true }
                 .fmap { |attributes| attributes.fetch :value }
                 .fmap { |value| value.round 2 }
                 .fmap { |value| value * 10 }
  end
end

# For Dry Transaction comparison.
Transactor = Class.new do
  include Dry::Monads[:result]
  include Dry::Transaction

  step :parse
  step :fetch
  step :round
  step :multiply

  private

  def parse(body) = Success JSON(body, symbolize_names: true)

  def fetch(attributes) = Success attributes.fetch(:value)

  def round(value) = Success value.round(2)

  def multiply(value) = Success value * 10
end

# For Kwork comparison (fast).
FastWorker = Class.new do
  include Kwork[operations: %i[parse fetch round multiply]]

  def call(body) = transaction { |step| step.multiply step.round(step.fetch(step.parse(body))) }

  private

  def parse(body) = success JSON(body, symbolize_names: true)

  def fetch(attributes) = success attributes.fetch(:value)

  def round(value) = success value.round(2)

  def multiply(value) = success value * 10
end

# For Kwork comparison (slow).
SlowWorker = Class.new do
  include Kwork[operations: %i[parse fetch round multiply], profiler: Profiler]

  def call(body) = transaction { |step| step.multiply step.round(step.fetch(step.parse(body))) }

  private

  def parse(body) = success JSON(body, symbolize_names: true)

  def fetch(attributes) = success attributes.fetch(:value)

  def round(value) = success value.round(2)

  def multiply(value) = success value * 10
end

# For Transactable comparison (fast).
FastComposer = Class.new do
  include Transactable

  def call(body) = pipe body, :parse, :fetch, :round, :multiply

  private

  def parse(body) = body.fmap { |content| JSON content, symbolize_names: true }

  def fetch(body) = body.fmap { |attributes| attributes.fetch :value }

  def round(value) = value.fmap { |number| number.round 2 }

  def multiply(value) = value.fmap { |number| number * 10 }
end

# For Transactable comparison (slow).
SlowComposer = Class.new do
  include Transactable

  def call body
    pipe body,
         fmap { |content| JSON content, symbolize_names: true },
         as(:fetch, :value),
         as(:round, 2),
         as(:*, 10)
  end
end

body = %({"value": 1.2345})
monader = Monader.new
transactor = Transactor.new
fast_worker = FastWorker.new
slow_worker = SlowWorker.new
fast_composer = FastComposer.new
slow_composer = SlowComposer.new

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report("Monad") { monader.call body }
  benchmark.report("Dry::Transction") { transactor.call body }
  benchmark.report("Kwork (fast)") { fast_worker.call body }
  benchmark.report("Kwork (slow)") { slow_worker.call body }
  benchmark.report("Transactable (fast)") { fast_composer.call body }
  benchmark.report("Transactable (slow)") { slow_composer.call body }

  benchmark.compare!
end

__END__

Warming up --------------------------------------
               Monad    36.447k i/100ms
     Dry::Transction    11.772k i/100ms
        Kwork (fast)    16.661k i/100ms
        Kwork (slow)     8.338k i/100ms
 Transactable (fast)    17.500k i/100ms
 Transactable (slow)     5.078k i/100ms
Calculating -------------------------------------
               Monad    364.600k (± 2.0%) i/s -      1.859M in   5.100100s
     Dry::Transction    118.527k (± 2.0%) i/s -    600.372k in   5.067072s
        Kwork (fast)    168.819k (± 2.4%) i/s -    849.711k in   5.036042s
        Kwork (slow)     85.408k (± 2.3%) i/s -    433.576k in   5.078824s
 Transactable (fast)    173.675k (± 2.4%) i/s -    875.000k in   5.040755s
 Transactable (slow)     50.390k (± 1.8%) i/s -    253.900k in   5.040125s

Comparison:
               Monad:   364600.3 i/s
 Transactable (fast):   173674.8 i/s - 2.10x  slower
        Kwork (fast):   168818.5 i/s - 2.16x  slower
     Dry::Transction:   118527.4 i/s - 3.08x  slower
        Kwork (slow):    85408.5 i/s - 4.27x  slower
 Transactable (slow):    50390.0 i/s - 7.24x  slower
